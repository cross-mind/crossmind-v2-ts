# ç³»ç»Ÿæ¶æ„

> ğŸ“– **ç›¸å…³æ–‡æ¡£**ï¼š[æ¶æ„åŸåˆ™](./01-architecture-principles.md) | [æŠ€æœ¯å®ç°](./03-implementation.md) | [æŠ€æœ¯æ¶æ„æ€»è§ˆ](../ARCHITECTURE.md)

## 2.1 äº”å±‚æ¶æ„æ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·ç«¯å±‚ (Client Layer)                                 â”‚
â”‚  Next.js 15 + useChat + Canvas UI                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API ç½‘å…³å±‚ (Gateway Layer)                              â”‚
â”‚  Route Handlers (/api/chat, /api/tasks, etc.)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI èƒ½åŠ›å±‚ (AI Layer)                                    â”‚
â”‚  Vercel AI SDK + è‡ªå»º Provider (crossmind-workspace-model)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Workspace å®¹å™¨å±‚ (Container Layer)                      â”‚
â”‚  Agent Server + Agent SDK + Claude Code CLI + MCP        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ•°æ®æŒä¹…å±‚ (Data Layer)                                 â”‚
â”‚  Postgres + Blob/S3 + pgvector                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2.2 æ¶æ„ç»„ä»¶è¯¦è§£

### 2.2.1 å®¢æˆ·ç«¯å±‚

**æŠ€æœ¯æ ˆ**ï¼š
- Next.js 15 (App Router)
- `@ai-sdk/react` (useChat hook)
- ShadCN/UI + Tailwind CSS
- Canvas å¯è§†åŒ–åº“ï¼ˆå¾…é€‰å‹ï¼šReact Flow / D3.jsï¼‰

**èŒè´£**ï¼š
- ç”¨æˆ·ç•Œé¢æ¸²æŸ“
- ä¸ `/api/chat` å»ºç«‹ SSE è¿æ¥
- Canvas èŠ‚ç‚¹æ“ä½œå’Œå¯è§†åŒ–
- ä»»åŠ¡çœ‹æ¿äº¤äº’

### 2.2.2 API ç½‘å…³å±‚

**æŠ€æœ¯æ ˆ**ï¼š
- Next.js Route Handlers
- NextAuth v5 (è®¤è¯)
- Drizzle ORM (æ•°æ®åº“è®¿é—®)

**æ ¸å¿ƒè·¯ç”±**ï¼š
- `POST /api/chat` - ç»Ÿä¸€ AI ä¼šè¯å…¥å£
- `GET /api/projects/:id/canvas` - è·å– Canvas æ•°æ®
- `POST /api/projects/:id/canvas/nodes` - åˆ›å»º/æ›´æ–° Canvas èŠ‚ç‚¹
- `GET /api/projects/:id/tasks` - è·å–ä»»åŠ¡åˆ—è¡¨
- `POST /api/projects/:id/tasks` - åˆ›å»ºä»»åŠ¡
- `POST /api/agent-services/orders` - åˆ›å»º Agent è®¢å•

### 2.2.3 AI èƒ½åŠ›å±‚

**æ ¸å¿ƒç»„ä»¶**ï¼š
- `createWorkspaceModel(projectId)` - è‡ªå»º LanguageModelV1 Provider
- System Prompt æ³¨å…¥å¼•æ“
- RAG æ£€ç´¢æœåŠ¡ï¼ˆpgvectorï¼‰

**å·¥ä½œæµç¨‹**ï¼š
1. æ¥æ”¶ç”¨æˆ·æ¶ˆæ¯ + projectId
2. ä»æ•°æ®åº“åŠ è½½é¡¹ç›®ä¸Šä¸‹æ–‡
3. æ‰§è¡Œ RAG æ£€ç´¢ï¼ˆç›¸å…³å†å²æ–‡æ¡£ã€å†³ç­–è®°å½•ï¼‰
4. æ„å»º System Prompt
5. è°ƒç”¨ Workspace Manager è·å–/åˆ›å»ºå®¹å™¨
6. è½¬å‘è¯·æ±‚åˆ° Workspace å®¹å™¨
7. æµå¼è¿”å›å“åº”

### 2.2.4 Workspace å®¹å™¨å±‚

**æŠ€æœ¯æ ˆ**ï¼š
- Node.js 20 + Express
- `@anthropic-ai/claude-agent-sdk`
- Claude Code CLI
- MCP (Model Context Protocol) å·¥å…·é›†

**å®¹å™¨ç»“æ„**ï¼š
```
/workspace-container/
â”œâ”€â”€ agent-server/          # Express HTTP æœåŠ¡å™¨
â”œâ”€â”€ .claude/
â”‚   â””â”€â”€ agents/           # å­ä»£ç†é…ç½®
â”œâ”€â”€ workspace/            # é¡¹ç›®æ–‡ä»¶ç›®å½•ï¼ˆæŒ‚è½½ PVCï¼‰
â”‚   â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ src/
â”‚   â””â”€â”€ .git/
â””â”€â”€ mcp-tools/            # MCP å·¥å…·é›†æˆ
    â”œâ”€â”€ github/
    â”œâ”€â”€ notion/
    â”œâ”€â”€ vercel/
    â””â”€â”€ crossmind/        # è‡ªå®šä¹‰å·¥å…·é›†
```

**å®¹å™¨ç”Ÿå‘½å‘¨æœŸ**ï¼š
- **åˆ›å»º**ï¼šç”¨æˆ·åˆ›å»ºé¡¹ç›®æˆ–è§¦å‘ Agent ä»»åŠ¡æ—¶
- **è¿è¡Œ**ï¼šä¿æŒæ´»è·ƒï¼Œæ”¯æŒå¤šè½®å¯¹è¯
- **é”€æ¯**ï¼šé¡¹ç›®åˆ é™¤æˆ–é•¿æ—¶é—´æ— æ´»åŠ¨ï¼ˆå¯é…ç½® TTLï¼‰

### 2.2.5 æ•°æ®æŒä¹…å±‚

**æ•°æ®åº“**ï¼š
- **Postgres (Neon)**ï¼šä¸»æ•°æ®åº“
- **pgvector**ï¼šå‘é‡æ£€ç´¢æ‰©å±•
- **Drizzle ORM**ï¼šç±»å‹å®‰å…¨çš„æ•°æ®åº“è®¿é—®

**å­˜å‚¨**ï¼š
- **Vercel Blob / S3**ï¼šæ–‡ä»¶å­˜å‚¨ï¼ˆæ–‡æ¡£ã€å›¾ç‰‡ã€å¯¼å‡ºæ–‡ä»¶ï¼‰
- **Upstash Redis**ï¼ˆå¯é€‰ï¼‰ï¼šç¼“å­˜å±‚

---

## 2.3 ä¸ºä»€ä¹ˆé‡‡ç”¨ Workspace Container æ¶æ„ï¼Ÿ

### 2.3.1 ä¼ ç»Ÿæ–¹æ¡ˆçš„å±€é™æ€§

`ai-sdk-provider-claude-code` çš„é»˜è®¤å‡è®¾æ˜¯ã€Œæœ¬åœ°å•æœºå¼€å‘ã€ï¼š
- ç›´æ¥åœ¨æœ¬æœº spawn Claude CLI å­è¿›ç¨‹
- å…±ç”¨ä¸€å¥—æ–‡ä»¶ç³»ç»Ÿã€è¿›ç¨‹ç©ºé—´

**åœ¨å¤šç§Ÿæˆ· SaaS ä¸­çš„é—®é¢˜**ï¼š
1. âŒ **æ— æ³•åšåˆ°æ¯ä¸ªé¡¹ç›®ç‹¬ç«‹æ–‡ä»¶ç³»ç»Ÿ**ï¼šæ‰€æœ‰é¡¹ç›®å…±äº«åŒä¸€æ–‡ä»¶ç³»ç»Ÿï¼Œå­˜åœ¨æ•°æ®æ³„éœ²é£é™©
2. âŒ **æ— æ³•å¯¹ Bash æƒé™åˆ†çº§ç®¡æ§**ï¼šæ— æ³•é™åˆ¶ç”¨æˆ·æ‰§è¡Œå±é™©å‘½ä»¤
3. âŒ **ç”¨æˆ·é—´è¿›ç¨‹/èµ„æºéš”ç¦»éš¾ä»¥ä¿è¯**ï¼šä¸€ä¸ªé¡¹ç›®çš„è¿›ç¨‹å¯èƒ½å½±å“å…¶ä»–é¡¹ç›®
4. âŒ **æ— æ³•æŒ‰é¡¹ç›®ç²¾ç»†è®¡è´¹/é™æµ**ï¼šéš¾ä»¥è¿½è¸ªå’Œé™åˆ¶å•ä¸ªé¡¹ç›®çš„èµ„æºä½¿ç”¨

### 2.3.2 CrossMind çš„è§£å†³æ–¹æ¡ˆ

**æ¶æ„é€‰æ‹©**ï¼š
- AI SDK ä¿ç•™åœ¨è¾¹ç¼˜/Serverlessï¼ˆåˆ©ç”¨ Vercel çš„å…¨çƒ CDNï¼‰
- Agent SDK + Claude Code CLI å…¨éƒ¨æ”¶çº³åˆ° Workspace å®¹å™¨é‡Œè¿è¡Œ
- ä¸­é—´ç”¨è‡ªå»ºçš„ LanguageModelV1 Provider æ‰“é€šä¸¤å±‚

**ä¼˜åŠ¿**ï¼š
- âœ… **å®Œå…¨éš”ç¦»**ï¼šæ¯ä¸ªé¡¹ç›®æ‹¥æœ‰ç‹¬ç«‹çš„æ–‡ä»¶ç³»ç»Ÿå’Œè¿›ç¨‹ç©ºé—´
- âœ… **æƒé™æ§åˆ¶**ï¼šå¯ä»¥åœ¨å®¹å™¨çº§åˆ«é™åˆ¶å¯æ‰§è¡Œçš„å‘½ä»¤å’Œå·¥å…·
- âœ… **èµ„æºç®¡ç†**ï¼šå¯ä»¥æŒ‰å®¹å™¨åˆ†é… CPUã€å†…å­˜ã€å­˜å‚¨é…é¢
- âœ… **å¯æ‰©å±•æ€§**ï¼šå®¹å™¨å¯ä»¥æ°´å¹³æ‰©å±•ï¼Œæ”¯æŒå¤šå®ä¾‹éƒ¨ç½²

---

## 2.4 æ•°æ®æµç¤ºæ„

### 2.4.1 æ ‡å‡†å¯¹è¯æµç¨‹

```
ç”¨æˆ·è¾“å…¥
  â”‚
  â–¼
[å‰ç«¯ useChat]
  â”‚ POST /api/chat
  â”‚ { projectId, message, canvasNodeId? }
  â–¼
[API Gateway]
  â”‚ 1. éªŒè¯è®¤è¯
  â”‚ 2. åŠ è½½é¡¹ç›®ä¸Šä¸‹æ–‡
  â”‚ 3. RAG æ£€ç´¢
  â–¼
[AI Provider: createWorkspaceModel]
  â”‚ æ„å»º System Prompt
  â”‚ è°ƒç”¨ Workspace Manager
  â–¼
[Workspace Manager]
  â”‚ æŸ¥æ‰¾/åˆ›å»º Workspace å®¹å™¨
  â”‚ HTTP/SSE è½¬å‘è¯·æ±‚
  â–¼
[Workspace Container]
  â”‚ Agent Server å¤„ç†
  â”‚ Claude Agent SDK æ‰§è¡Œ
  â”‚ è°ƒç”¨ MCP å·¥å…·
  â”‚ è¿”å›æµå¼å“åº”
  â–¼
[AI Provider]
  â”‚ è½¬å‘ SSE æµ
  â–¼
[API Gateway]
  â”‚ è½¬å‘ SSE æµ
  â–¼
[å‰ç«¯ useChat]
  â”‚ å®æ—¶æ¸²æŸ“æ¶ˆæ¯
```

### 2.4.2 Agent ä»»åŠ¡æ‰§è¡Œæµç¨‹

```
ç”¨æˆ·åœ¨é›‡ä½£ä¸­å¿ƒä¸‹å•
  â”‚
  â–¼
[åˆ›å»º agent_orders è®°å½•]
  â”‚
  â–¼
[Workspace Manager åˆ›å»º/å…³è”å®¹å™¨]
  â”‚
  â–¼
[Agent Server åŠ è½½æœåŠ¡æ¨¡æ¿]
  â”‚ 1. è¯»å– agent_services é…ç½®
  â”‚ 2. ç”Ÿæˆä»»åŠ¡ Prompt
  â”‚ 3. åˆå§‹åŒ– Agent SDK
  â–¼
[Agent æ‰§è¡Œä»»åŠ¡]
  â”‚ 1. è°ƒç”¨ MCP å·¥å…·ï¼ˆGitHub/Stripe/Vercelï¼‰
  â”‚ 2. ç”Ÿæˆæ–‡æ¡£/ä»£ç /é…ç½®
  â”‚ 3. é€šè¿‡ MCP å·¥å…·ä¿å­˜åˆ°çŸ¥è¯†åº“
  â”‚ 4. æ›´æ–°ä»»åŠ¡çŠ¶æ€
  â–¼
[ç”¨æˆ·åé¦ˆå¾ªç¯]
  â”‚ 1. ç”¨æˆ·æäº¤åé¦ˆ
  â”‚ 2. å†™å…¥ agent_order_feedback
  â”‚ 3. è§¦å‘ Agent é‡æ–°æ‰§è¡Œ
  â”‚ 4. è¿­ä»£è®¡æ•° +1
```
