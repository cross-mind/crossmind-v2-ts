# AI 能力集成 - 需求设计文档

> 📖 **相关文档**：[PRD](../../PRD.md) | [Canvas AI](./06-canvas-ai.md) | [Agent 执行](./10-agent-execution.md)

**文档版本**: 1.0
**最后更新**: 2024-12-08
**负责人**: 产品团队

---

## 1. 模块概述

### 1.1 模块定位

**核心价值**: 提供统一的 AI 交互能力，支撑 Canvas AI、Agent 执行等场景。

**使用场景**:
- Canvas 中与 AI 对话
- Agent 执行任务
- AI 操作 Canvas 和任务

### 1.2 模块边界

**包含功能**:
- AI 对话界面（通用）
- MCP 工具系统（产品视角）
- RAG 上下文管理
- 对话历史管理

**被依赖**: Canvas AI、Agent 执行

### 1.3 优先级

- **P0**: 对话界面、基础 MCP 工具、RAG
- **P1**: 高级 MCP 工具、对话管理
- **P2**: AI 个性化、多模型切换

---

## 2. 核心用户场景

### 场景 2.1: AI 对话

**基本流程**:
```
用户打开 AI 对话面板
    ↓
AI 显示上下文："当前节点：产品想法"
    ↓
用户输入"如何验证这个想法？"
    ↓
AI 分析项目上下文（RAG）
    ↓
AI 流式输出回答
    ↓
AI 建议："我可以帮你创建'用户调研'节点"
    ↓
用户确认 → 节点自动创建
```

### 场景 2.2: AI 操作 Canvas

**基本流程**:
```
用户："帮我创建一个市场调研节点"
    ↓
AI 调用 MCP 工具 create_canvas_node
    ↓
显示预览："即将创建节点'市场调研'"
    ↓
用户确认
    ↓
节点创建成功
```

---

## 3. 功能详细设计

### 3.1 AI 对话界面

#### 3.1.1 面板布局

**位置**: 右侧滑入（400px 宽）

**组成**:
- 顶部：上下文信息
- 中部：对话历史（滚动）
- 底部：输入框 + 发送

**交互**:
- 滑入动画：300ms
- 流式输出渲染
- Markdown 支持
- 代码高亮

**优先级**: P0

### 3.2 MCP 工具系统

#### 3.2.1 支持的工具

| 工具名 | 功能 | 需用户确认 | 优先级 |
|-------|------|-----------|-------|
| `create_canvas_node` | 创建 Canvas 节点 | ✅ | P0 |
| `update_canvas_node` | 更新节点内容 | ✅ | P0 |
| `create_task` | 创建任务 | ✅ | P0 |
| `update_task` | 更新任务 | ✅ | P0 |
| `search_project` | 搜索项目内容 | ❌ | P1 |
| `analyze_canvas` | 分析 Canvas 结构 | ❌ | P1 |

#### 3.2.2 工具调用流程

```
AI 决定使用工具
    ↓
生成工具调用请求
    ↓
[需确认] 显示预览："即将创建节点'XXX'"
    ↓
用户确认 / 拒绝
    ↓
[确认] 执行工具，返回结果
    ↓
AI 继续对话
```

**优先级**: P0

### 3.3 RAG 上下文管理

#### 3.3.1 上下文来源

**自动收集**:
- Canvas 节点内容
- 任务描述和评论
- Agent 产出
- 对话历史

**索引**: 实时更新向量索引

**优先级**: P0

#### 3.3.2 上下文检索

**触发**: 用户提问时自动检索相关内容

**展示**:
- AI 回答中引用："根据节点'用户调研'..."
- 可点击跳转到原内容

**优先级**: P0

### 3.4 对话历史管理

#### 3.4.1 历史保存

**保存内容**:
- 用户消息
- AI 回复
- 工具调用记录
- 时间戳

**保存时长**: 永久（直到用户删除）

**优先级**: P0

#### 3.4.2 对话归档 (P1)

**归档触发**:
- 对话超过 50 条消息
- 用户主动归档

**归档效果**:
- 新建对话窗口
- 旧对话可查看但不可继续

**优先级**: P1

---

## 4. 交互流程设计

### 4.1 AI 创建节点的完整流程

```
[用户] "帮我创建一个竞品分析节点"
    ↓
[AI] 分析意图：需要调用 create_canvas_node
    ↓
[AI] 生成预览：
     节点标题："竞品分析"
     节点类型：Research
     节点内容：[AI 生成的模板]
    ↓
[系统] 显示预览卡片："即将创建以下节点，是否确认？"
    ↓
[用户] 点击"确认"
    ↓
[系统] 调用 create_canvas_node API
    ↓
[系统] 节点创建成功，Canvas 更新
    ↓
[AI] "节点已创建✅，接下来需要我帮你分析竞品吗？"
```

---

## 5. 业务规则与逻辑

### 5.1 AI 操作权限

**需用户确认的操作**:
- 创建/删除内容
- 修改重要字段

**无需确认的操作**:
- 搜索和分析
- 提供建议

### 5.2 上下文限制

**Token 限制**: 单次对话最多 100K tokens

**超限处理**: 提示"对话过长，建议新建对话"

---

## 6. 验收标准

### 6.1 功能验收

- [ ] AI 对话流畅
- [ ] 流式输出正常
- [ ] MCP 工具正确调用
- [ ] RAG 检索准确
- [ ] 用户确认机制生效

### 6.2 性能指标

| 指标 | 目标值 |
|-----|-------|
| AI 首次响应 | < 2s |
| 流式输出延迟 | < 500ms |
| RAG 检索 | < 500ms |

---

## 附录

### A. 术语表

| 术语 | 定义 |
|-----|-----|
| MCP | Model Context Protocol，AI 工具调用协议 |
| RAG | Retrieval-Augmented Generation，检索增强生成 |
| 流式输出 | AI 回答逐字显示 |

### B. 变更历史

| 版本 | 日期 | 变更内容 | 负责人 |
|-----|------|---------|-------|
| 1.0 | 2024-12-08 | 初始版本 | 产品团队 |
