# 任务协作功能 - 需求设计文档

> 📖 **相关文档**：[PRD](../../PRD.md) | [任务管理核心](./07-task-management.md) | [通知系统](./14-notification-system.md)

**文档版本**: 1.0
**最后更新**: 2024-12-08
**负责人**: 产品团队

---

## 1. 模块概述

### 1.1 模块定位

**核心价值**: 增强任务中心的团队协作能力，通过活动流、评论、@提醒实现高效沟通。

**目标用户**: 小型创业团队（2-5人）

**使用场景**:
- 任务讨论：在任务中沟通问题
- 进度追踪：查看任务活动历史
- 快速提醒：@相关成员

### 1.2 模块边界

**包含功能**:
- 活动流（Activity Feed）
- 评论系统
- @ 提醒
- 多用户协作
- 角色权限

**依赖模块**:
- [任务管理核心](./07-task-management.md)
- [通知系统](./14-notification-system.md)

### 1.3 优先级

- **P0**: 活动流、评论、@ 提醒
- **P1**: 评论编辑/删除、表情回应
- **P2**: 评论线程、AI 总结

---

## 2. 核心用户场景

### 场景 2.1: 任务讨论

**用户故事**:
> "作为团队成员，我希望在任务中讨论问题，所以我需要评论功能"

**基本流程**:
```
用户打开任务详情
    ↓
在评论框输入"设计稿需要修改颜色"
    ↓
@ 提醒设计师 @Alice
    ↓
发送评论
    ↓
Alice 收到通知
```

### 场景 2.2: 查看任务历史

**用户故事**:
> "作为项目负责人，我希望了解任务的完整历史，所以我需要活动流"

**基本流程**:
```
用户打开任务详情
    ↓
查看活动流：
  - 12:00 @Bob 创建了任务
  - 12:30 @Alice 将状态改为 In Progress
  - 14:00 @Bob 添加了评论
  - 15:00 Agent 更新了任务内容
```

---

## 3. 功能详细设计

### 3.1 活动流 (Activity Feed)

#### 3.1.1 记录的活动类型

| 活动类型 | 示例 | 优先级 |
|---------|------|-------|
| 任务创建 | "@Bob 创建了任务" | P0 |
| 状态变更 | "@Alice 将状态改为 In Progress" | P0 |
| 字段修改 | "@Bob 修改了优先级：Medium → High" | P0 |
| 负责人变更 | "@Alice 将任务分配给 @Bob" | P0 |
| 截止日期修改 | "@Bob 设置截止日期为 2024-12-15" | P0 |
| 标签添加/删除 | "@Alice 添加了标签 stage/dev" | P1 |
| Agent 更新 | "@RedditAgent 完成了调研报告" | P0 |

#### 3.1.2 活动展示

**布局**: 时间线格式，最新在上

**内容**:
- 用户头像
- 操作描述
- 时间戳（相对时间，如 "2 小时前"）
- 变更前后对比（如需要）

**优先级**: P0

### 3.2 评论系统

#### 3.2.1 评论创建

**输入框**:
- 位置：任务详情页底部
- 支持 Markdown
- 支持 @ 提醒（输入 @ 弹出成员列表）
- 支持附件上传（P1）

**发送方式**:
- 点击"发送"按钮
- 快捷键 `Cmd/Ctrl + Enter`

**优先级**: P0

#### 3.2.2 评论展示

**布局**: 时间倒序，最新在上

**内容**:
- 评论者头像和姓名
- 评论内容（Markdown 渲染）
- 时间戳
- 操作按钮（编辑、删除、回复）

**优先级**: P0

#### 3.2.3 评论编辑和删除

**编辑**:
- 仅评论者可编辑
- 编辑后显示"已编辑"标记

**删除**:
- 评论者和项目 Owner 可删除
- 删除需确认

**优先级**: P1

### 3.3 @ 提醒功能

#### 3.3.1 @ 触发

**输入方式**:
- 输入 `@` 符号
- 弹出成员列表（项目成员 + Agent）
- 搜索过滤
- 选择或回车确认

**提及展示**:
- 高亮显示 @用户名
- 可点击跳转到用户资料

**优先级**: P0

#### 3.3.2 通知触发

**通知规则**:
- 被 @ 的用户立即收到通知
- 通知类型：关键通知（弹窗 + 邮件）
- 通知内容："{用户} 在任务 {任务标题} 中提到了你"

详见 [通知系统](./14-notification-system.md)

**优先级**: P0

### 3.4 多用户协作

#### 3.4.1 角色系统

| 角色 | 权限 | 说明 |
|------|------|------|
| Owner | 全部权限 | 项目创建者 |
| Member | 创建/编辑任务、评论 | 项目成员 |
| Guest | 仅查看 | 外部访客 |
| Agent | 限定范围操作 | 临时虚拟成员 |

**优先级**: P0

#### 3.4.2 权限控制矩阵

| 操作 | Owner | Member | Guest | Agent |
|------|-------|--------|-------|-------|
| 创建任务 | ✅ | ✅ | ❌ | ✅ |
| 删除任务 | ✅ | ✅(仅自己) | ❌ | ❌ |
| 评论 | ✅ | ✅ | ❌ | ✅ |
| @ 提醒 | ✅ | ✅ | ❌ | ❌ |
| 删除评论 | ✅ | ✅(仅自己) | ❌ | ❌ |
| 分配任务 | ✅ | ✅ | ❌ | ❌ |
| 邀请成员 | ✅ | ❌ | ❌ | ❌ |

---

## 4. 交互流程设计

### 4.1 完整的评论和提醒流程

```
[开始] 用户在任务详情页
    ↓
[操作] 点击评论框输入
    ↓
[用户] 输入 "@A"
    ↓
[系统] 弹出成员列表（Alice, Agent01...）
    ↓
[用户] 选择 @Alice，继续输入"请帮忙检查设计稿"
    ↓
[用户] 按 Cmd+Enter 发送
    ↓
[系统] 保存评论到数据库
    ↓
[系统] 添加活动记录："@Bob 添加了评论"
    ↓ (WebSocket)
[系统] 实时显示评论（所有在线用户可见）
    ↓ (通知系统)
[系统] 发送通知给 @Alice（弹窗 + 邮件）
    ↓
[Alice] 收到通知，点击跳转到任务
    ↓
[完成] Alice 查看评论并回复
```

**关键时间节点**:
- 评论发送响应: < 500ms
- WebSocket 同步: < 500ms
- 通知触发: < 1s

---

## 5. 业务规则与逻辑

### 5.1 活动记录规则

**记录内容**:
- 谁（actor）
- 什么时间（timestamp）
- 做了什么（action）
- 变更了什么（changes）

**不记录的活动**:
- 查看任务
- 打开任务详情
- 鼠标悬停

### 5.2 评论规则

**评论约束**:
- 内容: 1-5,000 字符
- @ 提醒: 单条评论最多 @ 10 人
- 编辑时限: 发送后 15 分钟内可编辑
- 删除: 软删除，7 天内可恢复

### 5.3 通知规则

**触发通知的场景**:
- 任务分配给我
- 任务中 @ 提到我
- 我负责的任务状态变更
- 我负责的任务有新评论

**通知合并**:
- 相同类型通知 5 分钟内合并
- 示例："@Bob 和其他 2 人在任务中评论"

---

## 6. 状态与数据流

### 6.1 评论状态管理

```typescript
interface CommentState {
  comments: Comment[]
  isSubmitting: boolean
  replyTo?: string  // 回复特定评论的 ID
  mentions: User[]  // @ 提及的用户列表
}
```

### 6.2 数据流向

**评论创建流程**:
```
用户输入 → 前端验证 → 提取 @ 用户 → API 调用 → 数据库写入 → WebSocket 广播 → 触发通知
```

---

## 7. 边界与异常处理

### 7.1 输入边界

**评论数量**: 单任务最多 1,000 条评论

**@ 提醒限制**: 单条评论最多 @ 10 人

### 7.2 异常处理

| 错误 | 提示 | 处理 |
|------|------|------|
| 评论失败 | "发送失败，请重试" | 提供重试按钮 |
| @ 用户不存在 | "用户已离开项目" | 移除 @ |
| 权限不足 | "无权限评论" | 禁用评论框 |

---

## 8. 验收标准

### 8.1 功能验收

- [ ] 活动流准确记录所有操作
- [ ] 评论发送成功率 > 99%
- [ ] @ 提醒正确触发通知
- [ ] WebSocket 实时同步
- [ ] 权限控制正确

### 8.2 性能指标

| 指标 | 目标值 |
|-----|-------|
| 评论发送响应 | < 500ms |
| 活动流加载 | < 1s |
| @ 搜索响应 | < 200ms |

---

## 附录

### A. 术语表

| 术语 | 定义 |
|-----|-----|
| 活动流 | 任务的所有操作历史记录 |
| @ 提醒 | 在评论中提及特定用户 |
| 角色权限 | 不同角色的操作权限 |

### B. 变更历史

| 版本 | 日期 | 变更内容 | 负责人 |
|-----|------|---------|-------|
| 1.0 | 2024-12-08 | 初始版本 | 产品团队 |
