# Agent 执行与反馈 - 需求设计文档

> 📖 **相关文档**：[PRD](../../PRD.md) | [Agent 雇佣中心](./09-agent-marketplace.md) | [任务管理](./07-task-management.md)

**文档版本**: 1.0
**最后更新**: 2024-12-08
**负责人**: 产品团队

---

## 1. 模块概述

### 1.1 模块定位

**核心价值**: Agent 任务执行和用户反馈循环，确保 AI 产出符合用户期望。

**目标用户**: 雇佣了 Agent 的用户

**使用场景**:
- 追踪 Agent 工作进度
- 查看 Agent 产出
- 提供反馈并迭代

### 1.2 模块边界

**包含功能**:
- Agent 临时账号机制
- 任务执行追踪
- 进度通知
- 反馈与迭代系统
- 完成与评价

**依赖模块**:
- [Agent 雇佣中心](./09-agent-marketplace.md)
- [任务管理核心](./07-task-management.md)
- [AI 能力集成](./12-ai-integration.md)

### 1.3 优先级

- **P0**: Agent 账号、任务追踪、反馈迭代
- **P1**: 评价系统、进度详情
- **P2**: Agent 性能分析

---

## 2. 核心用户场景

### 场景 2.1: Agent 开始工作

**用户故事**:
> "我雇佣了 Reddit 调研 Agent，希望了解 Agent 何时开始工作"

**基本流程**:
```
订单创建成功
    ↓
系统创建 Agent 临时账号 @RedditAgent
    ↓
在任务中心生成追踪任务"Reddit 调研：SaaS productivity tools"
    ↓
任务状态: In Progress，负责人: @RedditAgent
    ↓
用户收到通知"Agent 已开始工作"
```

### 场景 2.2: 查看产出并反馈

**用户故事**:
> "Agent 完成了初稿，我需要查看并提供反馈"

**基本流程**:
```
Agent 完成初稿
    ↓
任务状态更新为 Review
    ↓
用户收到通知"@RedditAgent 完成了调研报告"
    ↓
用户打开任务查看产出（Markdown 文档）
    ↓
用户在评论中反馈"请补充关于定价策略的讨论"
    ↓
Agent 收到反馈，开始迭代（迭代计数 1/3）
    ↓
Agent 更新产出
    ↓
用户满意后点击"标记完成"
```

---

## 3. 功能详细设计

### 3.1 Agent 临时账号机制

#### 3.1.1 虚拟成员身份

**账号特征**:
- 用户名：@{ServiceName}Agent（如 @RedditAgent）
- 头像：Agent 专属图标
- 在项目成员列表显示，标记"Agent"标签

**权限范围**:
- 仅对授权的任务有操作权限
- 可创建/更新 Canvas 节点（限定范围）
- 可更新任务状态
- 可添加评论
- 不能删除内容
- 不能 @ 提醒其他人

**优先级**: P0

#### 3.1.2 生命周期

**创建**: 订单创建时
**活跃期**: 任务执行期间
**归档**: 任务完成后 7 天归档（不删除，变为只读）

**优先级**: P0

### 3.2 任务执行追踪

#### 3.2.1 追踪任务生成

**任务信息**:
- 标题："[Agent] {服务名}：{用户输入概要}"
- 描述：自动生成，包含输入信息和服务说明
- 状态：In Progress
- 负责人：@AgentName
- 标签：`type/agent`, `stage/{相关阶段}`

**关联**:
- 关联到 Canvas 节点（如有）
- 关联到订单记录

**优先级**: P0

#### 3.2.2 进度实时更新

**更新方式**:
- Agent 通过 MCP 工具更新任务
- 添加评论说明进展
- 更新任务状态

**活动记录**:
- "@RedditAgent 开始分析 r/startups"
- "@RedditAgent 已处理 150 条帖子"
- "@RedditAgent 更新了调研报告"

**优先级**: P0

### 3.3 进度通知

#### 通知时机

| 事件 | 通知内容 | 优先级 |
|------|---------|-------|
| Agent 开始工作 | "Agent 已开始工作" | 低 |
| 完成初稿 | "Agent 完成了调研报告，请查看" | 高 |
| 需要反馈 | "Agent 需要你的反馈以继续" | 高 |
| 迭代完成 | "Agent 已更新产出，请查看" | 中 |
| 即将超限 | "还剩 1 次迭代机会" | 中 |
| 任务完成 | "Agent 任务已完成" | 低 |

详见 [通知系统](./14-notification-system.md)

**优先级**: P0

### 3.4 反馈与迭代系统

#### 3.4.1 用户提供反馈

**反馈方式**:
- 在任务评论中描述需求
- Agent 自动接收并分析

**反馈示例**:
- "请补充关于定价策略的内容"
- "图表不够清晰，请重新生成"
- "请重点分析 SaaS 类别的讨论"

**优先级**: P0

#### 3.4.2 Agent 迭代更新

**迭代流程**:
```
用户反馈 → Agent 分析 → Agent 更新产出 → 迭代计数 +1 → 用户查看
```

**迭代计数显示**:
- 任务详情页显示："已使用 2/5 次迭代"
- 用尽后提示："迭代次数已用完，继续需支付 $15/次"

**优先级**: P0

#### 3.4.3 迭代次数限制

根据服务类型，限制不同：

| 服务类型 | 基础迭代 | 超出价格 |
|---------|---------|---------|
| 简单调研 | 3 次 | $9/次 |
| 文档生成 | 5 次 | $15/次 |
| 代码生成 | 5 次 | $19/次 |
| 复杂任务 | 7 次 | $29/次 |

**超出处理**:
- 显示确认弹窗："继续迭代需支付 $15，是否继续？"
- 用户确认后支付并继续

**优先级**: P0

### 3.5 完成与评价

#### 3.5.1 标记完成

**触发方式**:
- 用户点击"标记完成"按钮
- 任务状态变为 Done
- Agent 账号进入归档状态

**优先级**: P0

#### 3.5.2 评价系统 (P1)

**评价维度**:
- 满意度：1-5 星
- 产出质量：1-5 星
- 响应速度：1-5 星
- 评价内容：文本（可选，匿名展示）

**评价展示**:
- 在服务详情页显示平均评分
- 展示用户评价（匿名）

**优先级**: P1

---

## 4. 交互流程设计

### 4.1 完整的执行与反馈流程

```
[开始] 订单创建成功
    ↓
[系统] 创建 Agent 临时账号 @RedditAgent
    ↓
[系统] 在任务中心生成追踪任务
    ↓ (通知)
[用户] 收到"Agent 已开始工作"通知
    ↓
[Agent] 执行调研（后台）
    ↓ (中间更新)
[Agent] 添加评论："已分析 r/startups，发现 50 个相关讨论"
    ↓ (1-2 小时后)
[Agent] 完成初稿，更新任务状态为 Review
    ↓ (通知)
[用户] 收到"Agent 完成了调研报告"通知（弹窗）
    ↓
[用户] 打开任务查看产出
    ↓
[用户] 在评论中反馈："请补充定价策略的讨论"
    ↓
[Agent] 接收反馈，开始迭代
    ↓
[系统] 更新迭代计数：1/3
    ↓ (30 分钟后)
[Agent] 更新产出，添加评论："已补充定价策略部分"
    ↓ (通知)
[用户] 收到更新通知，查看新版本
    ↓
[用户] 满意后点击"标记完成"
    ↓
[系统] 任务状态 Done，弹出评价窗口
    ↓
[用户] 评价（5星）并提交
    ↓
[完成] Agent 归档，任务完成
```

---

## 5. 业务规则与逻辑

### 5.1 Agent 权限规则

**Agent 可以**:
- 创建/更新追踪任务
- 添加评论
- 更新任务状态
- 创建 Canvas 节点（限定范围）
- 上传文件（产出）

**Agent 不可以**:
- 删除任务
- @ 提醒用户
- 访问其他任务
- 修改项目设置

### 5.2 迭代计数规则

**开始计数**: 用户首次提供反馈后

**不计数**:
- Agent 主动优化
- 修复明显错误

**计数**:
- 用户明确要求修改
- 用户提出新需求

### 5.3 超时处理

**执行超时**:
- 超过预计时间 2 倍仍未完成
- 系统提示用户："Agent 执行时间较长，可能遇到问题"
- 提供"取消订单"选项（全额退款）

---

## 6. 状态与数据流

### 6.1 Agent 任务状态

```typescript
interface AgentTask {
  orderId: string
  agentAccountId: string
  taskId: string
  status: 'running' | 'waiting_feedback' | 'completed'
  iterationCount: number
  outputs: AgentOutput[]
}
```

### 6.2 数据流向

**执行流程**:
```
订单创建 → Agent 账号创建 → 任务创建 → Agent 执行 → 产出保存 → 通知用户 → 用户反馈 → Agent 迭代 → 循环直至完成
```

---

## 7. 边界与异常处理

### 7.1 Agent 执行失败

**场景**: Agent 执行过程中出错

**处理**:
- Agent 添加评论说明错误
- 任务状态变为 Blocked
- 通知用户并提供选项：重试或取消退款

### 7.2 用户长期无反馈

**场景**: Agent 完成初稿后，用户 7 天未反馈

**处理**:
- 发送提醒通知
- 14 天后自动标记完成

---

## 8. 验收标准

### 8.1 功能验收

- [ ] Agent 账号正确创建
- [ ] 追踪任务自动生成
- [ ] 进度通知及时触发
- [ ] 迭代计数准确
- [ ] 超出迭代正确计费

### 8.2 性能指标

| 指标 | 目标值 |
|-----|-------|
| Agent 响应时间 | < 2s |
| 任务创建 | < 1s |
| 迭代更新 | < 30 分钟 |

---

## 附录

### A. 术语表

| 术语 | 定义 |
|-----|-----|
| Agent 临时账号 | Agent 执行任务时的虚拟成员身份 |
| 追踪任务 | 用于追踪 Agent 工作进度的任务 |
| 迭代计数 | 用户提供反馈的次数 |

### B. 变更历史

| 版本 | 日期 | 变更内容 | 负责人 |
|-----|------|---------|-------|
| 1.0 | 2024-12-08 | 初始版本 | 产品团队 |
