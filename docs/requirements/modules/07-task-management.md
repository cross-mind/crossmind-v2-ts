# 任务管理核心 - 需求设计文档

> 📖 **相关文档**：[PRD](../../PRD.md) | [产品功能模块](../02-features.md) | [任务协作](./08-task-collaboration.md) | [标签系统](./11-tagging-system.md)

**文档版本**: 1.0
**最后更新**: 2024-12-08
**负责人**: 产品团队

---

## 1. 模块概述

### 1.1 模块定位

**核心价值**: 类 Linear/Jira 的任务管理系统，帮助用户结构化管理项目任务，追踪进度，清晰分工。

**目标用户**:
- Solo Entrepreneur：管理个人项目任务
- 小型团队：团队任务分配和进度追踪

**使用场景**:
- 任务创建：从想法到可执行任务
- 进度追踪：看板视图直观展示状态
- 任务筛选：多维度过滤找到目标任务

### 1.2 模块边界

**包含功能**:
- 任务 CRUD
- 任务字段管理（标题、描述、状态、优先级、负责人、标签、截止日期、验收标准）
- 状态流转
- 看板视图和列表视图
- 子任务（最多 3 层）
- 任务依赖关系
- 批量操作

**不包含功能**:
- 活动流和评论（见 [任务协作](./08-task-collaboration.md)）
- Agent 执行追踪（见 [Agent 执行](./10-agent-execution.md)）

**依赖模块**:
- [标签系统](./11-tagging-system.md)
- [实时协作](./13-realtime-collaboration.md)

### 1.3 优先级定义

- **P0 (MVP)**: 任务 CRUD、看板视图、状态流转、基础字段
- **P1 (V1.0)**: 列表视图、子任务、依赖关系、批量操作
- **P2 (V2.0)**: 高级过滤、自定义视图、任务模板

---

## 2. 核心用户场景

### 场景 2.1: 创建任务

**用户故事**:
> "作为一个用户，我希望将 Canvas 中的想法转化为可执行的任务，所以我需要创建任务"

**基本流程**:
```
用户点击"创建任务"
    ↓
填写任务标题（必填）
    ↓
选择状态（默认 Todo）
    ↓
添加描述、优先级、负责人（可选）
    ↓
点击"创建"
    ↓
任务出现在看板的 Todo 列
```

**预期产出**: 一个新任务，状态为 Todo

### 场景 2.2: 看板视图追踪进度

**用户故事**:
> "作为一个团队成员，我希望看到所有任务的状态，所以我需要看板视图"

**基本流程**:
```
用户进入任务中心
    ↓
看到 4 列看板：Todo | In Progress | Review | Done
    ↓
每列显示对应状态的任务卡片
    ↓
拖拽任务卡片到其他列 = 改变状态
```

**预期产出**: 直观的任务状态分布

### 场景 2.3: 从 Canvas 节点创建任务

**用户故事**:
> "作为一个用户，我希望将 Canvas 节点转化为任务，所以我需要关联功能"

**基本流程**:
```
用户在 Canvas 选中节点
    ↓
右键 → "创建关联任务"
    ↓
任务标题自动填充节点标题
    ↓
任务描述自动填充节点内容
    ↓
用户补充字段，点击创建
    ↓
任务创建成功，节点显示关联图标
```

**预期产出**: 关联 Canvas 节点的任务

---

## 3. 功能详细设计

### 3.1 任务 CRUD

#### 3.1.1 创建任务

**触发方式**:
- 点击"新建任务"按钮
- 快捷键 `C` (Create)
- 从 Canvas 节点创建
- AI 从对话中抽取创建

**任务字段**:

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| 标题 | 文本 | 是 | 无 | 1-200 字符 |
| 描述 | Markdown | 否 | 无 | 0-10,000 字符 |
| 状态 | 枚举 | 是 | Todo | 5 种状态 |
| 优先级 | 枚举 | 否 | Medium | Low/Medium/High/Urgent |
| 负责人 | 用户选择 | 否 | 创建者 | 项目成员或 Agent |
| 标签 | 多选 | 否 | 无 | 支持 namespace |
| 截止日期 | 日期时间 | 否 | 无 | 不能早于创建时间 |
| 验收标准 | Markdown | 否 | 无 | Checklist 格式 |

**优先级**: P0

#### 3.1.2 编辑任务

**编辑方式**:
- 点击任务卡片进入详情页
- 详情页内联编辑各字段
- 修改自动保存（防抖 1s）

**优先级**: P0

#### 3.1.3 删除任务

**删除规则**:
- 有子任务：提示"任务包含 X 个子任务，是否一并删除？"
- Agent 正在执行：提示"Agent 正在工作，是否取消并删除？"
- 软删除：30 天内可恢复

**优先级**: P0

### 3.2 任务状态流转

#### 3.2.1 支持的状态

| 状态 | 颜色 | 说明 | 优先级 |
|------|------|------|-------|
| Todo | 灰色 | 待开始 | P0 |
| In Progress | 蓝色 | 进行中 | P0 |
| Review | 橙色 | 待审核 | P1 |
| Done | 绿色 | 已完成 | P0 |
| Blocked | 红色 | 阻塞 | P1 |
| Cancelled | 灰色 | 已取消 | P1 |

#### 3.2.2 状态流转规则

```
Todo ─────────────────��───→ Cancelled
  │                              ↑
  ↓ (点击"开始")                  │
In Progress ────────────────────┤
  │         ↓ (遇到问题)           │
  │      Blocked ────────────────┤
  │         ↓ (问题解决)           │
  ↓ (完成开发)                    │
Review ──────────────────────────┤
  │    ↓ (拒绝)                   │
  │    └─→ In Progress            │
  ↓ (批准)                       │
Done ────────────────────────────┘
```

**流转限制**:
- In Progress → Review: 需填写完成说明
- Review → Done: 需 reviewer 批准
- 任意状态 → Blocked: 需填写阻塞原因
- 任意状态 → Cancelled: 需填写取消原因

**优先级**: P0（Todo/In Progress/Done）, P1（其他状态）

### 3.3 看板视图

#### 3.3.1 布局

**列定义**:
- Todo（待办）
- In Progress（进行中）
- Review（审核中）- P1
- Done（已完成）

**任务卡片**:
- 显示：标题、优先级图标、负责人头像、标签、截止日期
- hover 显示：描述预览、子任务进度

**交互**:
- 拖拽任务卡片到其他列 = 改变状态
- 点击卡片进入详情页
- 快速操作：右键菜单（编辑、删除、分配）

**优先级**: P0

#### 3.3.2 过滤和排序

**过滤维度**:
- 负责人
- 优先级
- 标签
- 截止日期范围

**排序方式**:
- 优先级
- 截止日期
- 创建时间
- 更新时间

**优先级**: P1

### 3.4 列表视图

#### 3.4.1 表格列

| 列 | 宽度 | 排序 | 优先级 |
|-----|------|------|-------|
| 标题 | 自动 | ✅ | P1 |
| 状态 | 120px | ✅ | P1 |
| 优先级 | 100px | ✅ | P1 |
| 负责人 | 120px | ✅ | P1 |
| 截止日期 | 120px | ✅ | P1 |
| 标签 | 自动 | ❌ | P1 |

#### 3.4.2 高级过滤

**过滤器组合**:
- AND 逻辑：同时满足多个条件
- OR 逻辑：满足任一条件
- 保存过滤器配置

**优先级**: P1

### 3.5 子任务

#### 3.5.1 子任务规则

**层级限制**:
- 最多 3 层嵌套
- 子任务继承父任务的标签（可选）

**进度计算**:
- 父任务进度 = 已完成子任务数 / 总子任务数
- 显示进度条

**优先级**: P1

#### 3.5.2 子任务操作

**创建子任务**:
- 在任务详情页点击"添加子任务"
- 快捷键 `Cmd/Ctrl + Shift + N`

**子任务显示**:
- 看板卡片：显示子任务进度（3/5 完成）
- 列表视图：可展开/折叠子任务
- 详情页：完整子任务列表

**优先级**: P1

### 3.6 任务依赖关系

#### 3.6.1 依赖类型

**Blocks（阻塞）**:
- 任务 A blocks 任务 B = B 依赖 A 完成
- A 未完成时，B 不能开始

**示例**: "用户调研" blocks "PRD 编写"

**优先级**: P1

#### 3.6.2 依赖展示

**视觉提示**:
- 被阻塞任务显示锁图标
- Hover 显示："等待 '用户调研' 完成"

**依赖图**:
- 任务详情页显示依赖关系图
- 点击依赖任务快速跳转

**优先级**: P1

### 3.7 批量操作

#### 支持的批量操作

| 操作 | 说明 | 优先级 |
|------|------|-------|
| 批量修改状态 | 选中多个任务统一改状态 | P1 |
| 批量修改负责人 | 统一分配给某人 | P1 |
| 批量添加标签 | 统一打标签 | P1 |
| 批量删除 | 一次删除多个任务 | P1 |

**操作方式**:
- 复选框选中任务
- 顶部出现批量操作栏
- 选择操作类型，确认执行

**优先级**: P1

---

## 4. 交互流程设计

### 4.1 创建任务的完整流程

```
[开始] 用户在任务中心点击"新建任务"
    ↓
[系统] 弹出任务创建表单
    ↓
[用户] 输入标题"完成用户调研"（必填）
    ↓
[用户] 选择优先级"High"
    ↓
[用户] 添加标签 stage/research, skill/research
    ↓
[用户] 设置截止日期"2024-12-15"
    ↓
[用户] 点击"创建"
    ↓
[系统] 验证通过，保存到数据库
    ↓ (< 500ms)
[系统] 任务出现在看板 Todo 列
    ↓ (WebSocket)
[系统] 通知其他在线成员
    ↓
[完成] 任务创建成功
```

**关键时间节点**:
- 表单弹出: < 200ms
- 保存响应: < 500ms
- WebSocket 同步: < 500ms

---

## 5. 业务规则与逻辑

### 5.1 权限控制

| 操作 | Owner | Member | Guest | Agent |
|------|-------|--------|-------|-------|
| 创建任务 | ✅ | ✅ | ❌ | ✅ |
| 编辑任务 | ✅ | ✅ | ❌ | ✅(限定) |
| 删除任务 | ✅ | ✅(仅自己创建) | ❌ | ❌ |
| 修改状态 | ✅ | ✅ | ❌ | ✅ |
| 分配任务 | ✅ | ✅ | ❌ | ❌ |

### 5.2 数据验证规则

**字段约束**:
- 标题: 1-200 字符，必填
- 描述: 0-10,000 字符，Markdown
- 优先级: Low/Medium/High/Urgent
- 负责人: 必须是项目成员或 Agent
- 截止日期: 不能早于创建时间
- 标签: 最多 20 个

### 5.3 自动化规则

**状态自动更新**:
- 所有子任务完成 → 父任务状态提示"可以标记完成"
- 依赖任务完成 → 被阻塞任务移除锁定状态
- Agent 完成工作 → 关联任务状态更新

**通知触发**:
- 任务分配给我 → 通知
- 任务状态变更（我负责的）→ 通知
- 任务即将到期 → 提前 1 天通知
- 任务逾期 → 通知

---

## 6. 状态与数据流

### 6.1 前端状态管理

```typescript
interface TaskState {
  tasks: Task[]
  view: 'kanban' | 'list'
  filters: {
    assignee?: string[]
    priority?: string[]
    tags?: string[]
    status?: string[]
  }
  selectedTaskIds: string[]
  sortBy: 'priority' | 'dueDate' | 'createdAt'
}
```

### 6.2 数据流向

**任务创建流程**:
```
用户输入 → 前端验证 → 乐观更新 → API 调用 → 数据库写入 → WebSocket 广播 → 其他用户同步
```

**状态变更流程**:
```
拖拽/点击 → 前端状态更新 → API 调用 → 触发业务规则 → 数据库更新 → WebSocket 同步 → 触发通知
```

---

## 7. 边界与异常处理

### 7.1 输入边界

**任务数量限制**:
- 单项目最多 50,000 个任务
- 超出提示："任务数量已达上限"

**依赖循环检测**:
- 场景：任务 A 依赖 B，B 依赖 A
- 检测：创建依赖时检查循环
- 提示："检测到循环依赖，无法创建"

### 7.2 系统异常

| 错误 | 用户提示 | 处理 |
|------|---------|------|
| 网络超时 | "网络连接超时" | 自动重试 3 次 |
| 任务不存在 | "任务已被删除" | 返回任务列表 |
| 权限不足 | "无权限修改此任务" | 显示提示 |
| 依赖冲突 | "检测到循环依赖" | 阻止操作 |

---

## 8. 验收标准

### 8.1 功能验收

**基本功能**:
- [ ] 任务创建响应 < 500ms
- [ ] 看板视图流畅拖拽（60fps）
- [ ] 状态流转符合规则
- [ ] 子任务最多 3 层
- [ ] 依赖关系正确展示
- [ ] 批量操作一次成功

**交互体验**:
- [ ] 拖拽有视觉反馈
- [ ] 表单验证即时提示
- [ ] WebSocket 同步延迟 < 500ms

### 8.2 性能指标

| 指标 | 目标值 |
|-----|-------|
| 任务列表加载 | < 1s |
| 任务创建响应 | < 500ms |
| 看板拖拽流畅度 | 60fps |
| 1000 个任务流畅度 | 不卡顿 |

### 8.3 用户体验

**易用性**:
- [ ] 新用户可在 2 分钟内创建任务
- [ ] 状态流转直观易懂
- [ ] 过滤器使用率 > 40%

---

## 附录

### A. 术语表

| 术语 | 定义 |
|-----|-----|
| 看板视图 | Kanban 风格的任务展示，按状态分列 |
| 列表视图 | 表格形式的任务展示，支持高级过滤 |
| 子任务 | 任务的分解单元，最多 3 层嵌套 |
| 依赖关系 | 任务间的阻塞关系 |
| 批量操作 | 同时操作多个任务 |

### B. 参考资料

- [PRD](../../PRD.md)
- [产品功能模块](../02-features.md)
- [任务协作](./08-task-collaboration.md)
- [标签系统](./11-tagging-system.md)

### C. 变更历史

| 版本 | 日期 | 变更内容 | 负责人 |
|-----|------|---------|-------|
| 1.0 | 2024-12-08 | 初始版本 | 产品团队 |
