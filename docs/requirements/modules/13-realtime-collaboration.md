# 实时协作 - 需求设计文档

> 📖 **相关文档**：[PRD](../../PRD.md) | [Canvas 核心](./05-canvas-core.md) | [任务管理](./07-task-management.md)

**文档版本**: 1.0
**最后更新**: 2024-12-08
**负责人**: 产品团队

---

## 1. 模块概述

### 1.1 模块定位

**核心价值**: 支持多人实时协同工作，无缝同步操作，避免冲突。

**使用场景**:
- 团队成员同时编辑 Canvas
- 实时查看其他人操作
- 协同编辑任务

### 1.2 模块边界

**包含功能**:
- WebSocket 同步机制
- 在线状态显示
- 协作光标（Canvas）
- 冲突检测与解决
- 离线同步

**被依赖**: Canvas 核心、任务管理

### 1.3 优先级

- **P0**: WebSocket 同步、在线状态
- **P1**: 协作光标、冲突解决
- **P2**: 离线同步、版本历史

---

## 2. 核心用户场景

### 场景 2.1: 实时看到他人操作

**基本流程**:
```
Alice 在 Canvas 创建节点
    ↓ (WebSocket)
Bob 立即看到新节点出现（< 500ms）
    ↓
Alice 移动节点
    ↓
Bob 看到节点实时移动
```

### 场景 2.2: 协作编辑避免冲突

**基本流程**:
```
Alice 和 Bob 同时打开同一节点
    ↓
Alice 开始编辑（节点显示"Alice 正在编辑"）
    ↓
Bob 看到提示，等待或编辑其他部分
    ↓
Alice 保存
    ↓
Bob 看到更新内容
```

---

## 3. 功能详细设计

### 3.1 WebSocket 同步

#### 3.1.1 同步事件

| 事件类型 | 触发时机 | 优先级 |
|---------|---------|-------|
| `node.created` | 创建 Canvas 节点 | P0 |
| `node.updated` | 更新节点内容 | P0 |
| `node.moved` | 移动节点位置 | P0 |
| `task.created` | 创建任务 | P0 |
| `task.updated` | 更新任务 | P0 |
| `user.joined` | 用户上线 | P0 |
| `user.left` | 用户下线 | P0 |

#### 3.1.2 同步延迟

**目标**: < 500ms

**优化**:
- WebSocket 持久连接
- 批量发送（100ms 内合并）
- 增量更新

**优先级**: P0

### 3.2 在线状态显示

#### 3.2.1 成员列表

**显示内容**:
- 成员头像
- 在线/离线状态（绿点/灰色）
- 最近活跃时间

**位置**: 左侧边栏或右上角

**优先级**: P0

#### 3.2.2 在线人数统计

**显示**: "3 人在线"

**Hover**: 显示在线成员列表

**优先级**: P0

### 3.3 协作光标 (P1)

#### 3.3.1 光标显示

**Canvas 中**:
- 显示其他人的鼠标位置
- 光标带用户名和头像
- 不同用户不同颜色

**更新频率**: 100ms

**优先级**: P1

#### 3.3.2 编辑状态指示

**正在编辑的节点**:
- 显示边框高亮
- 显示"@Alice 正在编辑"

**优先级**: P1

### 3.4 冲突检测与解决

#### 3.4.1 冲突场景

**并发编辑**:
- 两人同时编辑同一节点/任务

**检测**: 比对 `updated_at` 时间戳

**优先级**: P1

#### 3.4.2 冲突解决策略

```
Alice 和 Bob 同时编辑节点
    ↓
Alice 先保存（12:00:00）
    ↓
Bob 后保存（12:00:02）
    ↓
系统检测冲突（Bob 的 base updated_at < 当前 updated_at）
    ↓
显示冲突提示："@Alice 刚刚修改了此节点"
    ↓
显示差异对比（Alice 的版本 vs Bob 的版本）
    ↓
Bob 选择：
  - 保留我的修改（覆盖 Alice）
  - 采用 Alice 的修改（放弃自己的）
  - 手动合并
```

**优先级**: P1

### 3.5 离线同步 (P2)

#### 3.5.1 离线操作缓存

**缓存内容**:
- 用户离线期间的所有操作
- 保存在 LocalStorage

**优先级**: P2

#### 3.5.2 重连同步

**流程**:
```
网络断开
    ↓
用户继续操作（本地缓存）
    ↓
网络恢复
    ↓
自动重连 WebSocket
    ↓
上传缓存的操作
    ↓
检测冲突并解决
    ↓
同步完成
```

**优先级**: P2

---

## 4. 交互流程设计

### 4.1 完整的实时协作流程

```
[Alice] 进入项目
    ↓
[系统] WebSocket 连接成功
    ↓
[系统] 广播 user.joined 事件
    ↓
[Bob] 看到"Alice 已上线"
    ↓
[Alice] 创建节点"市场调研"
    ↓
[系统] 广播 node.created 事件
    ↓ (< 500ms)
[Bob] Canvas 上出现新节点
    ↓
[Alice] 双击编辑节点
    ↓
[系统] 广播"Alice 正在编辑"
    ↓
[Bob] 看到节点边框高亮 + 提示
    ↓
[Alice] 保存内容
    ↓
[系统] 广播 node.updated 事件
    ↓
[Bob] 看到更新后的内容
    ↓
[Alice] 关闭浏览器
    ↓
[系统] 广播 user.left 事件
    ↓
[Bob] 看到"Alice 已离线"
```

---

## 5. 业务规则与逻辑

### 5.1 同步规则

**同步内容**:
- 所有 CRUD 操作
- 状态变更
- 位置移动

**不同步**:
- 鼠标移动（协作光标单独处理）
- 视口缩放
- 界面操作（打开/关闭面板）

### 5.2 冲突优先级

**规则**: 先保存者优先

**例外**: Owner 可强制覆盖

---

## 6. 验收标准

### 6.1 功能验收

- [ ] WebSocket 同步延迟 < 500ms
- [ ] 在线状态准确
- [ ] 冲突正确检测
- [ ] 协作光标流畅

### 6.2 性能指标

| 指标 | 目标值 |
|-----|-------|
| WebSocket 延迟 | < 500ms |
| 光标更新频率 | 100ms |
| 重连时间 | < 2s |

---

## 附录

### A. 术语表

| 术语 | 定义 |
|-----|-----|
| WebSocket | 实时双向通信协议 |
| 协作光标 | 显示其他用户鼠标位置 |
| 冲突检测 | 识别并发编辑冲突 |

### B. 变更历史

| 版本 | 日期 | 变更内容 | 负责人 |
|-----|------|---------|-------|
| 1.0 | 2024-12-08 | 初始版本 | 产品团队 |
