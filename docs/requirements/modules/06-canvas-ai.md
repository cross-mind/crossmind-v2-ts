# Canvas AI 增强 - 需求设计文档

> 📖 **相关文档**：[PRD](../../PRD.md) | [产品功能模块](../02-features.md) | [Canvas 核心](./05-canvas-core.md) | [AI 能力集成](./12-ai-integration.md)

**文档版本**: 1.0
**最后更新**: 2024-12-08
**负责人**: 产品团队

---

## 1. 模块概述

### 1.1 模块定位

**核心价值**: 通过 AI 能力增强 Canvas 的战略思维价值，帮助用户完善想法、应用方法论框架、自动拆解复杂节点。

**目标用户**:
- Solo Entrepreneur：不熟悉战略框架，需要 AI 指导
- 小型团队：希望快速应用成熟方法论

**使用场景**:
- 想法完善：AI 扫描 Canvas 提供建议
- 框架应用：一键应用 BMC、OKR 等模板
- 节点拆解：AI 自动拆解大节点为子节点

### 1.2 模块边界

**包含功能**:
- AI 对话面板
- 智能建议（扫描 Canvas，提示缺失模块）
- 自动拆解节点
- 关系推理（推荐连线）
- 预设模板应用

**不包含功能**:
- 基础 AI 对话能力（见 [AI 能力集成](./12-ai-integration.md)）
- Canvas 节点 CRUD（见 [Canvas 核心](./05-canvas-core.md)）

**依赖模块**:
- [Canvas 核心功能](./05-canvas-core.md)
- [AI 能力集成](./12-ai-integration.md)

### 1.3 优先级定义

- **P0 (MVP)**: AI 对话面板、智能建议、预设模板应用
- **P1 (V1.0)**: 自动拆解、关系推理
- **P2 (V2.0)**: 自定义模板、AI 学习用户偏好

---

## 2. 核心用户场景

### 场景 2.1: AI 辅助完善想法

**用户故事**:
> "作为一个 solo entrepreneur，我有一个模糊的想法，希望 AI 帮我完善，所以我需要与 AI 对话"

**基本流程**:
```
用户选中想法节点
    ↓
点击"✨ AI 辅助"按钮
    ↓
AI 对话面板从右侧滑入
    ↓
AI 主动提问："这个想法要解决什么问题？"
    ↓
用户回答
    ↓
AI 继续追问并给出建议
    ↓
AI 提议："我可以帮你创建'用户调研'和'竞品分析'节点"
    ↓
用户确认 → 节点自动创建
```

**预期产出**: 完善的想法节点 + 2-3 个相关子节点

### 场景 2.2: 应用预设模板

**用户故事**:
> "作为一个用户，我想用商业模式画布梳理想法，但不知道如何开始，所以我需要应用模板"

**基本流程**:
```
用户点击"应用模板"
    ↓
选择"商业模式画布 (BMC)"
    ↓
系统提示："模板包含 9 个模块，将在 Canvas 上自动创建"
    ↓
用户确认
    ↓
系统创建 9 个节点（客户细分、价值主张、渠道...）
    ↓
AI 提示："让我们从'客户细分'开始，你的目标用户是谁？"
```

**预期产出**: 结构化的 BMC 框架 + AI 引导填写

### 场景 2.3: AI 自动拆解节点

**用户故事**:
> "作为一个用户，我有一个复杂的节点，希望 AI 帮我拆解为可执行的小任务"

**基本流程**:
```
用户选中节点，右键"AI 拆解"
    ↓
AI 分析节点内容
    ↓
AI 提议："我建议拆解为 5 个子节点：..."
    ↓
显示拆解预览（可编辑）
    ↓
用户确认 → 自动创建子节点
```

**预期产出**: 3-7 个结构化的子节点

---

## 3. 功能详细设计

### 3.1 AI 对话面板

#### 3.1.1 面板布局

**位置**: 右侧滑入（400px 宽度，可调整）

**组成部分**:
- 顶部：上下文信息（当前节点标题）
- 中部：对话历史（滚动区域）
- 底部：输入框 + 发送按钮

**交互细节**:
- 面板滑入动画：300ms ease-out
- 自动聚焦输入框
- 支持 Markdown 渲染
- 代码块语法高亮
- 支持折叠/展开

**优先级**: P0

#### 3.1.2 对话触发

**触发方式**:
- 选中节点后点击"✨ AI 辅助"
- 快捷键 `Cmd/Ctrl + K`
- 右键菜单"与 AI 对话"

**上下文传递**:
- 当前节点内容
- 父子节点关系
- 节点标签
- 项目相关文档（RAG）

**优先级**: P0

### 3.2 智能建议

#### 3.2.1 AI 扫描 Canvas

**触发时机**:
- 用户主动点击"获取 AI 建议"
- 节点数量达到阈值（如 5 个）时自动提示

**扫描逻辑**:
- 分析节点类型分布
- 识别缺失的关键模块
- 检测孤立节点（无连线）

**建议类型**:
- "建议添加'竞品分析'节点"
- "建议连接'用户调研'和'产品定位'节点"
- "建议为'MVP 开发'节点添加子任务"

**优先级**: P0

#### 3.2.2 建议展示

**展示方式**:
- 侧边栏建议列表（按重要性排序）
- 每条建议带"接受"和"忽略"按钮

**接受建议**:
- 一键创建建议的节点
- 自动添加标签
- 自动建立关系（如需要）

**优先级**: P0

### 3.3 自动拆解节点

#### 3.3.1 拆解触发

**操作方式**:
- 右键节点 → "AI 拆解"
- 选中节点后按快捷键 `Cmd/Ctrl + D`

**适用场景**:
- 节点内容较多（> 200 字）
- 节点包含多个要点

**优先级**: P1

#### 3.3.2 拆解逻辑

**AI 分析**:
- 识别节点中的关键要点
- 提取可独立的模块
- 建议子节点标题和类型

**拆解预览**:
- 显示拆解结构树
- 用户可编辑子节点标题
- 用户可调整层级

**创建子节点**:
- 保留原节点作为父节点
- 自动创建 3-7 个子节点
- 继承父节点标签

**优先级**: P1

### 3.4 关系推理

#### 3.4.1 推荐连线

**触发时机**:
- 用户创建新节点后
- 用户主动请求"建议关系"

**推理逻辑**:
- 语义相似度分析
- 时序关系（A 必须在 B 之前）
- 依赖关系（A 依赖 B 的产出）

**展示方式**:
- 虚线显示建议的连线
- 标注连线类型（依赖/支持/冲突）
- 用户点击确认或忽略

**优先级**: P1

### 3.5 预设模板应用

#### 3.5.1 支持的模板

| 模板名称 | 节点数 | 使用场景 | 优先级 |
|---------|-------|---------|-------|
| 商业模式画布 (BMC) | 9 | 商业模式梳理 | P0 |
| OKR 框架 | 3-5 | 目标设定 | P0 |
| 精益画布 | 9 | 精益创业 | P0 |
| 产品战略图 | 6-8 | 产品战略 | P1 |

**优先级**: P0（前 3 个模板）

#### 3.5.2 模板应用流程

**操作方式**:
- 点击"应用模板"按钮
- 选择模板类型
- 预览模板结构
- 确认应用

**应用效果**:
- 自动创建所有模板节点
- 自动添加类型标签
- 自动建立节点关系
- AI 引导填写每个模块

**优先级**: P0

---

## 4. 交互流程设计

### 4.1 AI 辅助完善想法的完整流程

```
[开始] 用户在 Canvas 选中"SaaS 产品想法"节点
    ↓
[操作] 点击"✨ AI 辅助"按钮
    ↓ (300ms 滑入动画)
[系统] AI 对话面板打开，显示上下文："当前节点：SaaS 产品想法"
    ↓
[AI] 主动询问："这个 SaaS 产品要解决什么问题？"
    ↓
[用户] 回答："帮助小团队管理项目"
    ↓
[AI] "明白了。目标用户是小团队。我建议创建以下节点："
       - 用户调研（了解小团队的痛点）
       - 竞品分析（分析现有工具）
       - 核心功能定义
    ↓
[系统] 显示预览（3个节点卡片）
    ↓
[用户] 点击"确认创建"
    ↓
[系统] 在 Canvas 上自动创建 3 个子节点
    ↓
[AI] "接下来让我们从用户调研开始，需要我帮你雇佣 Reddit 调研 Agent 吗？"
    ↓
[完成] 想法节点已完善，可进入下一步
```

**关键时间节点**:
- 面板打开: 300ms
- AI 首次响应: < 2s
- 节点创建: < 500ms

---

## 5. 业务规则与逻辑

### 5.1 AI 操作权限

| 操作 | 需要用户确认 | 可撤销 |
|------|------------|-------|
| 建议 | ❌ | - |
| 创建节点 | ✅ | ✅ |
| 修改节点 | ✅ | ✅ |
| 删除节点 | ✅ | ✅ |
| 添加连线 | ✅ | ✅ |

### 5.2 AI 建议优先级

**建议评分规则**:
- 缺失关键模块：高优先级
- 优化建议：中优先级
- 可选增强：低优先级

**展示限制**:
- 最多同时显示 5 条建议
- 按优先级排序

### 5.3 模板应用规则

**冲突处理**:
- 如果 Canvas 已有节点，提示："将在现有节点旁边创建模板"
- 不覆盖现有节点

**模板定制**:
- P0: 使用预设模板
- P1: 支持用户保存自定义模板

---

## 6. 状态与数据流

### 6.1 AI 对话状态

```typescript
interface AIDialogState {
  isOpen: boolean
  context: {
    nodeId: string
    nodeTitle: string
    nodeContent: string
  }
  messages: Message[]
  isAIThinking: boolean
  suggestedActions: Action[]
}
```

### 6.2 数据流向

**AI 建议流程**:
```
用户请求 → 前端收集上下文 → 发送给 AI Provider → AI 分析 → 返回建议 → 前端展示
```

**应用模板流程**:
```
选择模板 → 加载模板定义 → 预览展示 → 用户确认 → 批量创建节点 → WebSocket 同步
```

---

## 7. 边界与异常处理

### 7.1 AI 服务异常

| 错误 | 用户提示 | 处理方式 |
|------|---------|---------|
| AI 超时 | "AI 响应超时，请重试" | 提供重试按钮 |
| Token 超限 | "对话过长，请新建对话" | 建议归档当前对话 |
| 模型过载 | "AI 服务繁忙，预计等待 30 秒" | 显示等待队列 |

### 7.2 节点创建冲突

**场景**: AI 建议创建的节点已存在
**处理**: 提示"节点 'XXX' 已存在，是否更新内容？"

---

## 8. 验收标准

### 8.1 功能验收

**基本功能**:
- [ ] AI 对话面板正常打开和关闭
- [ ] AI 响应时间 < 2s
- [ ] 智能建议准确性 > 70%
- [ ] 模板应用一键完成
- [ ] 节点自动拆解合理（3-7 个子节点）

**交互体验**:
- [ ] 面板滑入动画流畅
- [ ] Markdown 渲染正确
- [ ] 代码高亮显示
- [ ] AI 操作需用户确认

### 8.2 性能指标

| 指标 | 目标值 |
|-----|-------|
| AI 首次响应 | < 2s |
| 流式输出延迟 | < 500ms |
| 模板应用 | < 1s |
| 节点拆解 | < 2s |

### 8.3 用户体验

**AI 建议质量**:
- [ ] 建议准确性 > 70%
- [ ] 建议相关性 > 80%
- [ ] 用户接受率 > 50%

---

## 附录

### A. 术语表

| 术语 | 定义 |
|-----|-----|
| 智能建议 | AI 扫描 Canvas 后提供的改进建议 |
| 自动拆解 | AI 将复杂节点分解为子节点 |
| 关系推理 | AI 推荐节点之间的连线关系 |
| 预设模板 | 预定义的方法论框架（如 BMC） |

### B. 预设模板详情

#### 商业模式画布 (BMC)

9 个模块：
1. 客户细分 (Customer Segments)
2. 价值主张 (Value Propositions)
3. 渠道通路 (Channels)
4. 客户关系 (Customer Relationships)
5. 收入来源 (Revenue Streams)
6. 核心资源 (Key Resources)
7. 关键业务 (Key Activities)
8. 重要伙伴 (Key Partners)
9. 成本结构 (Cost Structure)

#### OKR 框架

- 1 个 Objective（目标）
- 3-5 个 Key Results（关键结果）

### C. 变更历史

| 版本 | 日期 | 变更内容 | 负责人 |
|-----|------|---------|-------|
| 1.0 | 2024-12-08 | 初始版本 | 产品团队 |
