# Canvas 核心功能 - 需求设计文档

> 📖 **相关文档**：[PRD](../../PRD.md) | [产品功能模块](../02-features.md) | [用户旅程](../04-user-journey.md) | [模块导航](./README.md)

**文档版本**: 1.0
**最后更新**: 2024-12-08
**负责人**: 产品团队

---

## 1. 模块概述

### 1.1 模块定位

**核心价值**: Canvas 是可视化的战略思维空间，帮助用户将散落的想法结构化组织，形成清晰的项目战略。

**目标用户**:
- Solo Entrepreneur（主要）：需要整理和验证多个想法
- 小型创业团队：需要可视化展示项目战略和全局

**使用场景**:
- 想法孵化：记录和组织新想法
- 战略规划：应用方法论框架（BMC、OKR）梳理战略
- 项目演进：追踪从想法到执行的完整过程

### 1.2 模块边界

**包含功能**:
- 节点 CRUD（创建、编辑、删除、移动）
- 节点类型和层级结构
- 节点连线和分组
- 画布操作（缩放、拖动、框选）
- 标签管理
- Markdown 编辑器

**不包含功能**:
- AI 对话和智能建议（见 [Canvas AI 增强](./06-canvas-ai.md)）
- 模板应用（见 [Canvas AI 增强](./06-canvas-ai.md)）
- 实时协作光标（见 [实时协作](./13-realtime-collaboration.md)）

**依赖模块**:
- [标签系统](./11-tagging-system.md)
- [实时协作](./13-realtime-collaboration.md)

### 1.3 优先级定义

- **P0 (MVP)**: 节点 CRUD、节点类型、层级结构、基础画布操作、标签
- **P1 (V1.0)**: 节点连线、分组、高级画布操作
- **P2 (V2.0)**: 批量操作、历史版本、高级过滤

---

## 2. 核心用户场景

### 场景 2.1: 创建第一个想法节点

**用户故事**:
> "作为一个 solo entrepreneur，我希望能够快速记录脑海中的想法，所以我需要在 Canvas 上创建节点"

**基本流程**:
```
用户在 Canvas 空白区域双击
    ↓
系统在点击位置创建新节点（默认标题"未命名"）
    ↓
节点自动进入编辑模式，标题可编辑
    ↓
用户输入标题，按 Enter 或点击外部保存
    ↓
节点保存成功，显示在 Canvas 上
```

**预期产出**: 一个新的想法节点，带标题和空白内容

### 场景 2.2: 拆解想法为子节点

**用户故事**:
> "作为一个用户，我希望能够将大想法拆解为小模块，所以我需要创建子节点"

**基本流程**:
```
用户选中父节点
    ↓
点击"添加子节点"按钮或快捷键
    ↓
系统在父节点下方创建子节点（带缩进）
    ↓
用户编辑子节点内容
```

**预期产出**: 层级结构清晰的节点树（最多5层）

### 场景 2.3: 组织和整理节点

**用户故事**:
> "作为一个用户，我希望能够整理 Canvas 上的节点，所以我需要移动、分组和标记节点"

**基本流程**:
- 拖拽移动节点位置
- 框选多个节点批量移动
- 添加分组框整理相关节点
- 为节点添加标签（如 `type/idea`, `stage/research`）

---

## 3. 功能详细设计

### 3.1 节点管理

#### 3.1.1 节点创建

**操作方式**:
- 双击 Canvas 空白区域
- 快捷键 `N` (New)
- 右键菜单 "创建节点"

**界面要素**:
| 元素 | 类型 | 必填 | 默认值 | 验证规则 |
|------|------|------|--------|---------|
| 标题 | 文本框 | 是 | "未命名文档" | 1-100 字符 |
| 类型 | 下拉选择 | 否 | Document | 4种预设类型 |
| 标签 | 标签选择器 | 否 | 无 | 最多 20 个 |

**交互细节**:
- 创建动画：淡入 + 缩放（200ms）
- 自动聚焦标题输入框
- ESC 键取消创建

**优先级**: P0

#### 3.1.2 节点编辑

**操作方式**:
- 双击节点进入编辑模式
- 选中节点后按 `Enter`
- 右键菜单 "编辑"

**编辑界面**:
- 标题编辑（单行文本）
- 内容编辑（Markdown 编辑器，支持预览）
- 类型切换
- 标签管理

**优先级**: P0

#### 3.1.3 节点删除

**操作方式**:
- 选中节点按 `Delete` 或 `Backspace`
- 右键菜单 "删除"

**删除规则**:
- 单节点删除：直接删除（软删除，30天可恢复）
- 有子节点：提示"节点包含 X 个子节点，是否一并删除？"
- 关联任务：自动解除关联，不删除任务

**优先级**: P0

### 3.2 节点类型

#### 支持的节点类型（MVP: 4种）

| 类型 | 图标 | 颜色 | 使用场景 | 默认 | 优先级 |
|------|------|------|---------|------|-------|
| Document | 📄 | 蓝色 | 通用文档，知识沉淀（PRD、报告、方案、纪要等） | ✅ | P0 |
| Task | ☑️ | 灰色 | 行动项，关联任务中心 | ❌ | P0 |
| Idea | 💡 | 黄色 | 早期想法，待验证的创意 | ❌ | P0 |
| Agent | 🤖 | 紫色 | AI 生成的内容（自动标记来源） | ❌ | P0 |

#### 节点类型说明

**Document** 📄 - **默认类型，核心节点**
- **用途**: 所有文档性内容的容器
- **典型内容**: PRD、调研报告、技术方案、会议纪要、决策记录、用户故事等
- **特点**: 用户创建节点时的默认类型，90% 的节点都是文档

**Task** ☑️ - **行动节点**
- **用途**: 可执行的任务，关联任务中心
- **特点**: 显示任务状态（Todo/In Progress/Done），点击可跳转到任务详情
- **与 Document 区别**: Document 描述"是什么/为什么"，Task 描述"谁做/何时完成"

**Idea** 💡 - **灵感节点**
- **用途**: 早期的、未经验证的想法和创意
- **特点**: 允许粗糙、鼓励发散思维
- **演化**: Idea → 验证/细化 → Document → 分解为 Task

**Agent** 🤖 - **AI 生成节点**
- **用途**: AI 自动生成的内容
- **特点**: 自动标记"由 @AgentName 生成"，提示用户需人工审核
- **创建**: 仅由 Agent 自动创建，用户不可手动选择此类型

#### 节点类型演化流程

```
Idea 💡 ──验证/细化──→ Document 📄 ──分解──→ Task ☑️
                          ↑
                     Agent 🤖
                    (AI 自动生成)
```

#### 类型切换

- 编辑模式下可切换类型（Agent 类型除外）
- 类型变更后图标和颜色自动更新
- Agent 类型节点可转换为 Document（去除 AI 标记）

#### 移除的类型及替代方案

| 原类型 | 替代方案 | 说明 |
|-------|---------|------|
| Research | Document + 标签 `stage/research` | 调研报告本质是文档 |
| Prototype | Document + 标签 `stage/prototype` | 原型设计文档也是文档 |
| Decision | Document + 标签 `type/decision` | 决策记录是特殊文档，使用频率低 |
| Link | Document 中的 Markdown 链接 | 单独的链接节点价值不大 |

### 3.3 层级结构

#### 父子关系

**规则** (MVP 精简版):
- **最多支持 2-3 层嵌套**（降低复杂度，满足核心需求）
- 子节点继承父节点的部分标签（如 `stage/*`）
- 父节点进度计算：显示子节点完成比例（如 "3/5 完成"）

**视觉展示**:
- 缩进显示层级（每层缩进 20px）
- 折叠/展开控制（点击父节点左侧箭头）
- 父节点显示子节点数量徽章

**典型用例**:
```
📄 产品战略（父节点）
  ├─ 📄 市场分析
  ├─ 📄 用户调研
  │   ├─ ☑️ 完成 10 个用户访谈
  │   └─ ☑️ 整理访谈记录
  └─ 💡 MVP 功能设想
```

**优先级**: P0

### 3.4 画布操作

#### 基础操作

**缩放**:
- 鼠标滚轮缩放
- 快捷键 `Cmd/Ctrl +` 和 `Cmd/Ctrl -`
- 缩放范围: 25% - 200%

**拖动**:
- 按住空格 + 鼠标拖拽移动画布
- 双指触控板滑动

**框选**:
- 鼠标拖拽框选多个节点
- 支持批量移动

**优先级**: P0

#### 节点定位和布局

**手动布局**:
- 用户可自由拖拽节点位置
- 相同标签的节点建议手动聚集在一起形成"视觉分组"

**标签过滤可视化**:
- 点击标签时，只显示该标签的节点
- 其他节点半透明显示（可选择完全隐藏）
- 清除过滤器恢复全部显示

**说明**: MVP 阶段不实现自动分组和连线功能，使用标签 + 手动布局替代。V1.0 可考虑添加简化版分组。

**优先级**: P0

### 3.6 标签管理

详见 [标签系统](./11-tagging-system.md)

**Canvas 特有标签**:
- `type/*`: idea, research, prototype, decision, task, link
- `level/*`: strategy, module, task
- `stage/*`: ideation, research, design, dev, launch

**优先级**: P0

---

## 4. 交互流程设计

### 4.1 完整的节点创建与编辑流程

```
[开始] 用户进入 Canvas
    ↓
[操作1] 双击空白区域
    ↓ (200ms 动画)
[系统] 创建节点，自动聚焦标题
    ↓
[操作2] 用户输入标题 "SaaS 产品想法"
    ↓
[操作3] 按 Tab 键切换到内容编辑
    ↓
[操作4] 输入 Markdown 内容
    ↓
[操作5] 添加标签 type/idea, stage/ideation
    ↓
[操作6] 点击外部或 ESC 保存
    ↓ (WebSocket 同步)
[系统] 保存成功，通知其他在线用户
    ↓
[完成] 节点显示在 Canvas 上
```

**关键时间节点**:
- 节点创建动画: 200ms
- 保存响应时间: < 500ms
- WebSocket 同步延迟: < 500ms

---

## 5. 业务规则与逻辑

### 5.1 权限控制

| 操作 | Owner | Member | Guest | Agent |
|------|-------|--------|-------|-------|
| 创建节点 | ✅ | ✅ | ❌ | ✅(限定) |
| 编辑节点 | ✅ | ✅ | ❌ | ✅(限定) |
| 删除节点 | ✅ | ✅(仅自己创建) | ❌ | ❌ |
| 移动节点 | ✅ | ✅ | ❌ | ❌ |
| 查看节点 | ✅ | ✅ | ✅ | ✅ |

### 5.2 数据验证规则

**节点字段约束**:
- 标题: 1-100 字符，必填
- 内容: 0-50,000 字符，Markdown 格式
- 标签: 最多 20 个，每个 ≤50 字符
- 位置: X/Y 坐标在 Canvas 范围内（-10000 to 10000）
- 类型: 枚举值（6种预设类型）
- 层级: 最多 5 层

### 5.3 状态流转规则

**节点状态**:
- `not_started`: 未开始（默认）
- `in_progress`: 进行中
- `blocked`: 阻塞
- `completed`: 已完成

**流转规则**:
- 任意状态可切换到任意状态
- 父节点完成需所有子节点完成
- 关联任务完成时，节点状态自动更新

---

## 6. 状态与数据流

### 6.1 前端状态管理

```typescript
interface CanvasState {
  nodes: CanvasNode[]              // 所有节点
  selectedNodeIds: string[]        // 选中的节点 ID
  viewport: {                      // 视口状态
    x: number
    y: number
    zoom: number
  }
  mode: 'view' | 'edit' | 'select' // 当前模式
  clipboard: CanvasNode[]          // 剪贴板
}
```

### 6.2 数据流向

**创建节点**:
```
用户操作 → 前端验证 → 乐观更新 → API 调用 → 数据库写入 → WebSocket 广播 → 其他用户同步
```

**编辑节点**:
```
用户输入 → 本地缓存 → 防抖(1s) → API 调用 → 保存成功 → WebSocket 同步
```

### 6.3 缓存策略

| 数据 | 缓存位置 | 时长 | 失效条件 |
|------|---------|------|---------|
| 节点列表 | 内存 | 5分钟 | WebSocket 更新 |
| 单个节点内容 | 内存 | 10分钟 | 节点更新事件 |
| 视口状态 | LocalStorage | 持久 | 用户清除 |

---

## 7. 边界与异常处理

### 7.1 输入边界

**节点数量限制**:
- 单项目最多 10,000 个节点
- 超出提示: "节点数量已达上限，请归档旧节点"

**并发编辑冲突**:
- 检测: 比对 `updated_at` 时间戳
- 处理: 后保存者看到冲突提示，显示差异
- 选项: "保留我的" / "采用对方" / "手动合并"

### 7.2 系统异常

| 错误类型 | 状态码 | 用户提示 | 重试 |
|---------|-------|---------|-----|
| 网络超时 | - | "网络连接超时" | 自动重试 3 次 |
| 服务器错误 | 500 | "服务器繁忙" | 不重试 |
| 权限不足 | 403 | "无权限操作" | 不重试 |
| 节点不存在 | 404 | "节点已被删除" | 不重试 |

### 7.3 数据完整性

**软删除机制**:
- 删除节点后 30 天内可恢复
- 回收站功能
- 关联数据处理：任务关联自动解除，评论保留

---

## 8. 验收标准

### 8.1 功能验收

**基本功能**:
- [ ] 双击创建节点，200ms 内显示
- [ ] 节点编辑保存，500ms 内响应
- [ ] 节点删除带确认，软删除可恢复
- [ ] 节点拖拽移动流畅（60fps）
- [ ] 支持 6 种节点类型
- [ ] 支持最多 5 层嵌套

**交互体验**:
- [ ] 所有动画流畅（60fps）
- [ ] 编辑模式自动聚焦
- [ ] 快捷键正常工作
- [ ] WebSocket 同步延迟 < 500ms

**边界情况**:
- [ ] 节点数量达到上限时有提示
- [ ] 并发编辑冲突正确处理
- [ ] 网络断开后操作可缓存

### 8.2 性能指标

| 指标 | 目标值 | 测试方法 |
|-----|-------|---------|
| Canvas 初始加载 | < 2s | Performance API |
| 节点创建响应 | < 200ms | 前端监控 |
| 100 个节点流畅度 | 60fps | Chrome DevTools |
| WebSocket 同步 | < 500ms | 多浏览器测试 |

### 8.3 用户体验

**易用性**:
- [ ] 新用户无需教程可创建节点
- [ ] 操作错误率 < 5%

**满意度**:
- [ ] 功能满意度 NPS > 50
- [ ] 界面美观度 > 4.0/5.0

---

## 附录

### A. 术语表

| 术语 | 定义 |
|-----|-----|
| Canvas | 可视化思维空间 |
| 节点 | Canvas 上的基本单元，包含文档内容 |
| 层级结构 | 父子节点的嵌套关系 |
| 软删除 | 标记为删除但保留数据，可恢复 |

### B. 参考资料

- [产品需求文档 PRD](../../PRD.md)
- [产品功能模块](../02-features.md)
- [用户旅程设计](../04-user-journey.md)
- [标签系统](./11-tagging-system.md)

### C. 变更历史

| 版本 | 日期 | 变更内容 | 负责人 |
|-----|------|---------|-------|
| 1.0 | 2024-12-08 | 初始版本 | 产品团队 |
